<!DOCTYPE html>
<html lang="{{ lang }}" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ t.page_title_protocol_config }}</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap-icons.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='vislog.css') }}">
    <script src="{{ url_for('static', filename='jsonview.js') }}"></script>
    <script src="{{ url_for('static', filename='vislog.js') }}"></script>
</head>
<body>
    <!-- Header Bar -->
    <div class="controls-bar bg-body-secondary border-bottom p-3">
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
            <h5 class="mb-0">{{ t.select_columns_heading }}</h5>
            <div class="d-flex align-items-center gap-2">
                <a href="/{{ 'en' if lang == 'de' else 'de' }}/{{ request.path.split('/')[2:] | join('/') }}{% if request.query_string %}?{{ request.query_string.decode() }}{% endif %}" class="btn btn-sm btn-outline-secondary btn-lang" title="{{ t.switch_language }}">
                    {{ 'EN' if lang == 'de' else 'DE' }}
                </a>
                <button class="btn btn-sm btn-outline-secondary" onclick="toggleTheme()" title="{{ t.toggle_theme }}">
                    <i class="bi bi-sun-fill d-none" id="theme-icon-light"></i>
                    <i class="bi bi-moon-fill" id="theme-icon-dark"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="container py-4">
        {% if data.dropped_lines_count %}
        <!-- Warning banner for truncated CSV data -->
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <strong>{{ t.warning_label }}</strong> {{ t.dropped_lines_warning.replace('${count}', data.dropped_lines_count | string) }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endif %}

        <!-- Column Selection Card -->
        <div class="card mb-4">
            <div class="card-body">
                <!-- Search -->
                <div class="mb-3">
                    <input type="text" class="form-control" id="column-search" placeholder="{{ t.search_columns_placeholder }}" onkeyup="filter_columns()">
                </div>

                <!-- Controls -->
                <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
                    <button class="btn btn-sm btn-outline-secondary" onclick="toggle_all_columns(true)">
                        <i class="bi bi-check-all"></i> {{ t.select_all }}
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="toggle_all_columns(false)">
                        <i class="bi bi-x-lg"></i> {{ t.deselect_all }}
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="select_default_columns()">
                        <i class="bi bi-arrow-counterclockwise"></i> {{ t.default_selection }}
                    </button>
                    <span id="column-count" class="text-secondary small ms-auto"></span>
                </div>

                <!-- Columns Grid -->
                <div class="columns-grid border rounded p-3 bg-body-tertiary mb-3" id="column-checkboxes">
                    {% for column in data.column_metadata %}
                    <div class="column-item" data-column="{{ column.name }}">
                        <input type="checkbox" class="form-check-input"
                               id="col-{{ loop.index }}"
                               data-column="{{ column.name }}"
                               {% if not column.hidden_by_default %}checked{% endif %}>
                        <label for="col-{{ loop.index }}" title="{{ column.name }}">
                            <span class="column-label">{{ column.label }}</span>
                            {% if column.predefined %}
                            <span class="predefined-badge badge bg-secondary">{{ t.predefined_badge }}</span>
                            {% endif %}
                        </label>
                    </div>
                    {% endfor %}
                </div>

                <!-- Action Buttons -->
                <div class="d-flex flex-wrap gap-2 mb-3">
                    <button class="btn btn-primary" onclick="view_chart()">
                        <i class="bi bi-graph-up"></i> {{ t.show_chart }}
                    </button>
                    <button class="btn btn-outline-secondary" onclick="copy_link()">
                        <i class="bi bi-link-45deg"></i> {{ t.copy_link }}
                    </button>
                </div>

                <!-- Shareable Link -->
                <div class="bg-body-tertiary rounded p-3">
                    <label for="shareable-url" class="form-label fw-semibold">{{ t.shareable_link }}</label>
                    <input type="text" class="form-control font-monospace" id="shareable-url" readonly onclick="this.select()">
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs nav-tabs-vislog" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="before-json-tab" data-bs-toggle="tab" data-bs-target="#before-protocol-json" type="button" role="tab">
                    {{ t.tab_config_before }}
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="after-json-tab" data-bs-toggle="tab" data-bs-target="#after-protocol-json" type="button" role="tab">
                    {{ t.tab_config_after }}
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="before-log-tab" data-bs-toggle="tab" data-bs-target="#before-protocol-log" type="button" role="tab">
                    {{ t.tab_log_before }}
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="after-log-tab" data-bs-toggle="tab" data-bs-target="#after-protocol-log" type="button" role="tab">
                    {{ t.tab_log_after }}
                </button>
            </li>
        </ul>

        <div class="tab-content border border-top-0 rounded-bottom">
            <div class="tab-pane fade show active p-3" id="before-protocol-json" role="tabpanel">
            </div>
            <div class="tab-pane fade p-3" id="after-protocol-json" role="tabpanel">
            </div>
            <div class="tab-pane fade p-3" id="before-protocol-log" role="tabpanel">
                <textarea id="before-protocol-log-text" class="form-control log-textarea" rows="20" readonly></textarea>
            </div>
            <div class="tab-pane fade p-3" id="after-protocol-log" role="tabpanel">
                <textarea id="after-protocol-log-text" class="form-control log-textarea" rows="20" readonly></textarea>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='bootstrap.bundle.min.js') }}"></script>
    <script>
        const T = {{ t | tojson }};
        const uuid = "{{ data.uuid }}";
        const lang = "{{ lang }}";
        let data = {{ data | tojson }};

        function filter_columns() {
            const searchTerm = document.getElementById('column-search').value.toLowerCase();
            const columnItems = document.querySelectorAll('.column-item');
            let visibleCount = 0;

            columnItems.forEach(item => {
                const label = item.querySelector('label').textContent.toLowerCase();
                if (label.includes(searchTerm)) {
                    item.style.display = 'flex';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });

            update_column_count(visibleCount, columnItems.length);
        }

        function update_column_count(visible, total) {
            const countElement = document.getElementById('column-count');
            if (visible < total) {
                countElement.textContent = T.columns_shown_filtered.replace('${visible}', visible).replace('${total}', total);
            } else {
                countElement.textContent = T.columns_available.replace('${total}', total);
            }
        }

        function toggle_all_columns(select) {
            const checkboxes = document.querySelectorAll('#column-checkboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                if (checkbox.closest('.column-item').style.display !== 'none') {
                    checkbox.checked = select;
                }
            });
            update_url();
        }

        function select_default_columns() {
            const checkboxes = document.querySelectorAll('#column-checkboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                const columnName = checkbox.dataset.column;
                const columnMeta = data.column_metadata.find(col => col.name === columnName);
                checkbox.checked = columnMeta && !columnMeta.hidden_by_default;
            });
            update_url();
        }

        function get_selected_columns() {
            const checkboxes = document.querySelectorAll('#column-checkboxes input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.dataset.column);
        }

        function update_url() {
            const selectedColumns = get_selected_columns();
            const configParam = encodeURIComponent(selectedColumns.join(','));
            const url = window.location.origin + '/' + lang + '/' + uuid + '?configuration=' + configParam;
            document.getElementById('shareable-url').value = url;
        }

        function view_chart() {
            const selectedColumns = get_selected_columns();
            if (selectedColumns.length === 0) {
                alert(T.select_at_least_one);
                return;
            }
            const configParam = encodeURIComponent(selectedColumns.join(','));
            window.location.href = '/' + lang + '/' + uuid + '?configuration=' + configParam;
        }

        function copy_link() {
            const urlField = document.getElementById('shareable-url');
            urlField.select();
            urlField.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(urlField.value).then(() => {
                const button = event.target.closest('button');
                const originalHTML = button.innerHTML;
                button.innerHTML = '<i class="bi bi-check"></i> ' + T.copied;
                button.classList.add('btn-success');
                button.classList.remove('btn-outline-secondary');
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.classList.remove('btn-success');
                    button.classList.add('btn-outline-secondary');
                }, 2000);
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const checkboxes = document.querySelectorAll('#column-checkboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', update_url);
            });

            // Check if there's a 'selected' parameter in the URL (from "Spalten Ã¤ndern" button)
            // and apply it to restore the previous selection
            const urlParams = new URLSearchParams(window.location.search);
            const selectedParam = urlParams.get('selected');
            if (selectedParam) {
                const selectedColumns = decodeURIComponent(selectedParam).split(',');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = selectedColumns.includes(checkbox.dataset.column);
                });
            }

            const protocolJson = data.before_protocol_json || data.after_protocol_json || {};
            const hwVersion = _detectHwVersion(protocolJson);
            const jsonviewOpts = data.api_constants
                ? { apiConstants: data.api_constants, hwVersion: hwVersion }
                : {};
            make_jsonview(data.before_protocol_json, '#before-protocol-json', jsonviewOpts);
            make_jsonview(data.after_protocol_json, '#after-protocol-json', jsonviewOpts);

            document.getElementById('before-protocol-log-text').value = data.before_protocol_log;
            document.getElementById('after-protocol-log-text').value = data.after_protocol_log;

            update_column_count(data.column_metadata.length, data.column_metadata.length);
            update_url();
        });
    </script>
</body>
</html>
