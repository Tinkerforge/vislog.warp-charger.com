<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WARP Charger protocol visualizer - Spalten auswählen</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='vislog.css') }}">
    <script src="{{ url_for('static', filename='jsonview.js') }}"></script>
</head>
<body>
    <div class="config-container">
        <h1>Spalten für Visualisierung auswählen</h1>

        <div class="column-selection">
            <div class="search-container">
                <input type="text" id="column-search" placeholder="Spalten durchsuchen..." onkeyup="filter_columns()">
            </div>

            <div class="column-controls">
                <button onclick="toggle_all_columns(true)">Alle auswählen</button>
                <button onclick="toggle_all_columns(false)">Alle abwählen</button>
                <button onclick="select_default_columns()">Standard-Auswahl</button>
                <span id="column-count"></span>
            </div>

            <div class="columns-grid" id="column-checkboxes">
                {% for column in data.column_metadata %}
                <div class="column-item" data-column="{{ column.name }}">
                    <input type="checkbox"
                           id="col-{{ loop.index }}"
                           data-column="{{ column.name }}"
                           {% if not column.hidden_by_default %}checked{% endif %}>
                    <label for="col-{{ loop.index }}" title="{{ column.name }}">
                        <span class="column-label">{{ column.label }}</span>
                        {% if column.predefined %}
                        <span class="predefined-badge">Standard</span>
                        {% endif %}
                    </label>
                </div>
                {% endfor %}
            </div>

            <div class="action-buttons">
                <button class="primary-button" onclick="view_chart()">Chart anzeigen</button>
                <button class="secondary-button" onclick="copy_link()">Link kopieren</button>
            </div>

            <div class="shareable-link">
                <h4>Teilbarer Link:</h4>
                <input type="text" id="shareable-url" readonly onclick="this.select()">
            </div>
        </div>

        <div class="tab">
            <button class="tablinks active" onclick="open_tab(event, 'before-protocol-json')">Konfiguration vor dem Ladeprotokoll</button>
            <button class="tablinks" onclick="open_tab(event, 'after-protocol-json')">Konfiguration nach dem Ladeprotokoll</button>
            <button class="tablinks" onclick="open_tab(event, 'before-protocol-log')">Log vor dem Ladeprotokoll</button>
            <button class="tablinks" onclick="open_tab(event, 'after-protocol-log')">Log nach dem Ladeprotokoll</button>
        </div>

        <div id="before-protocol-json" class="tabcontent" style="display:block;">
        </div>
        <div id="after-protocol-json" class="tabcontent">
        </div>
        <div id="before-protocol-log" class="tabcontent">
            <textarea id="before-protocol-log-text" rows="30" readonly>{{ data.before_protocol_log }}</textarea>
        </div>
        <div id="after-protocol-log" class="tabcontent">
            <textarea id="after-protocol-log-text" rows="30" readonly>{{ data.after_protocol_log }}</textarea>
        </div>
    </div>

    <script>
        const uuid = "{{ data.uuid }}";
        let data = {{ data | tojson }};

        function open_tab(evt, tab) {
            var i, tabcontent, tablinks;

            // Get all elements with class="tabcontent" and hide them
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }

            // Get all elements with class="tablinks" and remove the class "active"
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }

            // Show the current tab, and add an "active" class to the button that opened the tab
            document.getElementById(tab).style.display = "block";
            evt.currentTarget.className += " active";
        }

        function filter_columns() {
            const searchTerm = document.getElementById('column-search').value.toLowerCase();
            const columnItems = document.querySelectorAll('.column-item');
            let visibleCount = 0;

            columnItems.forEach(item => {
                const label = item.querySelector('label').textContent.toLowerCase();
                if (label.includes(searchTerm)) {
                    item.style.display = 'flex';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });

            update_column_count(visibleCount, columnItems.length);
        }

        function update_column_count(visible, total) {
            const countElement = document.getElementById('column-count');
            if (visible < total) {
                countElement.textContent = `${visible} von ${total} Spalten angezeigt`;
            } else {
                countElement.textContent = `${total} Spalten verfügbar`;
            }
        }

        function toggle_all_columns(select) {
            const checkboxes = document.querySelectorAll('#column-checkboxes input[type="checkbox"]:not([style*="display: none"])');
            checkboxes.forEach(checkbox => {
                if (checkbox.closest('.column-item').style.display !== 'none') {
                    checkbox.checked = select;
                }
            });
            update_url();
        }

        function select_default_columns() {
            const checkboxes = document.querySelectorAll('#column-checkboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                const columnItem = checkbox.closest('.column-item');
                const isPredefined = columnItem.querySelector('.predefined-badge') !== null;
                const columnName = checkbox.dataset.column;

                // Find the column metadata
                const columnMeta = data.column_metadata.find(col => col.name === columnName);
                checkbox.checked = columnMeta && !columnMeta.hidden_by_default;
            });
            update_url();
        }

        function get_selected_columns() {
            const checkboxes = document.querySelectorAll('#column-checkboxes input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.dataset.column);
        }

        function update_url() {
            const selectedColumns = get_selected_columns();
            const configParam = encodeURIComponent(selectedColumns.join(','));
            const url = window.location.origin + '/' + uuid + '?configuration=' + configParam;
            document.getElementById('shareable-url').value = url;
        }

        function view_chart() {
            const selectedColumns = get_selected_columns();
            if (selectedColumns.length === 0) {
                alert('Bitte wählen Sie mindestens eine Spalte aus.');
                return;
            }
            const configParam = encodeURIComponent(selectedColumns.join(','));
            window.location.href = '/' + uuid + '?configuration=' + configParam;
        }

        function copy_link() {
            const urlField = document.getElementById('shareable-url');
            urlField.select();
            urlField.setSelectionRange(0, 99999); // For mobile devices
            document.execCommand('copy');

            // Visual feedback
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'Kopiert!';
            setTimeout(() => {
                button.textContent = originalText;
            }, 2000);
        }

        function make_jsonview(json, selector) {
            const tree = jsonview.create(json);
            jsonview.render(tree, document.querySelector(selector));
            jsonview.expand(tree);
            jsonview.traverse(tree, function(node) {
                if(node.key.includes('modified')) {
                    if(node.value.modified == 2) {
                        search = node.key.replace('_modified', '')
                        jsonview.traverse(tree, function(node) {
                            if(node.key == search) {
                                node.el.classList.add("important");
                            }
                        });
                    }
                }
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners to checkboxes
            const checkboxes = document.querySelectorAll('#column-checkboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', update_url);
            });

            // Initialize JSON views
            make_jsonview(data.before_protocol_json, '#before-protocol-json');
            make_jsonview(data.after_protocol_json, '#after-protocol-json');

            // Initialize count and URL
            update_column_count(data.column_metadata.length, data.column_metadata.length);
            update_url();
        });
    </script>
</body>
</html>